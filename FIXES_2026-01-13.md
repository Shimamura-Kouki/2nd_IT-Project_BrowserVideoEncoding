# 修正内容 - 2026-01-13

## 概要
動画が正常に作成されない問題とプログレスバーが正しく動作しない問題を解決しました。

## 主な修正内容

### 1. プログレスバーの改善

#### 問題
- フォーマット検出段階（STEP 1）でも進捗が表示されていた
- エンコーディング段階（STEP 5）のファイル読み込み進捗が「encoding」ステージとして誤って報告されていた
- フラッシング・ファイナライズ段階の進捗が不正確だった

#### 修正内容
- **STEP 1（フォーマット検出）**: 進捗報告を削除（高速処理のため不要）
- **STEP 5（実エンコーディング）**: ファイル読み込み進捗を「reading」ステージとして正しく報告
- **フラッシング段階**: ビデオエンコーダーとオーディオエンコーダーのフラッシュを分離（0% → 50% → 100%）
- **ファイナライズ段階**: 進捗更新を追加（0% → 50% → 100%）

#### 効果
- 各処理段階で適切な進捗バーが表示される
- 高速処理では進捗バーを表示しない（企画書の要件に準拠）
- ユーザーが現在の処理状況を正確に把握できる

### 2. オーディオタイムスタンプの修正（重要）

#### 問題
オーディオエンコーダーがマイクロ秒単位のタイムスタンプを直接mp4-muxerに渡していた。
mp4-muxerはミリ秒単位を期待しているため、タイムスタンプが1000倍になり、以下の問題が発生：
- オーディオとビデオの同期ずれ
- MP4ファイルの再生不可能
- STTSテーブルの破損

#### 修正内容
```javascript
// 修正前（誤り）
const finalTs = audioChunkCount === 1 ? 0 : normalizedTs;  // マイクロ秒のまま
const metaAdj = { ...meta, timestamp: finalTs };

// 修正後（正しい）
const finalTsMs = normalizedTsUs / 1000;  // ミリ秒に変換
const durationMs = durUs / 1000;  // ミリ秒に変換
const metaAdj = { ...meta, timestamp: finalTsMs, duration: durationMs };
```

#### 効果
- オーディオとビデオの完全な同期
- 正常に再生可能なMP4ファイルの生成
- ビデオエンコーダーと同じタイムスタンプ処理方式を採用

### 3. コードの改善

#### 修正内容
- 誤解を招くコメントを修正
- オーディオチャンクのログ出力を改善（ビデオと同じフォーマット）
- `chunk.timestamp`を使用（`meta.timestamp`から変更、ビデオとの一貫性）
- `encodedVideoUs`カウンターのリセットを追加（正確な進捗計算のため）

## 技術詳細

### タイムスタンプ単位の変換

WebCodecs APIとmp4-muxerの間には、タイムスタンプ単位の不一致があります：

- **WebCodecs API**: マイクロ秒（μs）単位でタイムスタンプを出力
- **mp4-muxer**: ミリ秒（ms）単位でタイムスタンプを期待（GLOBAL_TIMESCALE = 1000）

**変換式**:
```javascript
timestampMs = timestampUs / 1000
durationMs = durationUs / 1000
```

### 処理フロー

1. **STEP 1**: フォーマット検出（進捗報告なし）
   - 高速処理のため進捗バーは表示しない
   - ビデオ・オーディオフォーマットを検出
   - 総再生時間（duration）を取得

2. **STEP 2-4**: エンコーダー・Muxer初期化
   - 検出されたフォーマットに基づいて設定
   - Muxerを先に初期化（重要：エンコード開始前）

3. **STEP 5**: 実エンコーディング
   - ファイル読み込み: 'reading' ステージ（0-100%）
   - フレームエンコーディング: 'encoding' ステージ（0-100%）
   - エンコーダーフラッシュ: 'flushing' ステージ（0-100%）
   - ファイナライズ: 'finalizing' ステージ（0-100%）

## 検証方法

### ビルド確認
```bash
cd video-encoder-app/frontend
npm install
npm run build
```

### 動作確認
1. ブラウザで`index.html`を開く（ローカルサーバー推奨）
2. MP4ファイルを選択
3. プリセットを選択（バックエンドAPI接続時）
4. エンコード開始
5. 各ステージの進捗バーが正しく表示されることを確認：
   - 📖 ファイル読み込み (0-100%)
   - 🎬 エンコード (0-100%)
   - 💾 フラッシング (0-100%)
   - ✅ ファイナライズ (0-100%)
6. 出力ファイルがVLCなどのメディアプレイヤーで正常に再生できることを確認

### コンソールログ確認
期待されるログ出力：
```
STEP 1: Detecting format...
Detected format: {video: {...}, audio: {...}}
Format detection complete. Total duration: XXXXX us
STEP 2: VideoEncoder configuration
STEP 3: Initializing Muxer BEFORE encoding starts...
STEP 4: AudioEncoder configured
STEP 5: Starting actual encoding with muxer initialized...
✅ Counters reset for second encoding pass
🎥 FIRST DECODED FRAME: {...}
🎬 FIRST VIDEO CHUNK: {type: 'key', ...}
🎵 FIRST AUDIO CHUNK: {...}
[CHUNK 1] ts: 0.00ms, dur: 33.33ms, type: key
[AUDIO CHUNK 1] ts: 0.00ms, dur: 23.22ms
...
Total video chunks added to muxer: XXXX
Total audio chunks added to muxer: XXXX
Encode complete!
```

## 企画書との整合性

### ブラウザ完結
- ✅ すべての動画エンコード処理はブラウザ内で実行
- ✅ FileSystem Access APIを使用したストリーム書き込み
- ✅ WebCodecs APIによるハードウェアアクセラレーション
- ✅ バックエンドは設定共有のみ（任意）

### 進捗表示
- ✅ 各処理段階で適切な進捗バー表示
- ✅ 高速処理（フォーマット検出）は進捗バー非表示
- ✅ FPSと経過時間のリアルタイム表示

### 動画品質
- ✅ オーディオ・ビデオの完全同期
- ✅ 正しいタイムスタンプとduration
- ✅ 標準メディアプレイヤーで再生可能

## セキュリティ
- ✅ CodeQL スキャン: 0件の脆弱性
- ✅ クライアントサイド処理のみ（動画データはサーバーに送信されない）
- ✅ FileSystem Access APIによる安全なファイル保存

## 今後の改善提案

1. **エラーハンドリング**: より詳細なエラーメッセージと回復処理
2. **プログレスバー**: エンコード段階でより細かい進捗更新
3. **パフォーマンス**: 大容量ファイルの処理最適化
4. **互換性**: Safari/Firefoxへの対応（Polyfill検討）

## 参考資料
- [WebCodecs API - MDN](https://developer.mozilla.org/en-US/docs/Web/API/WebCodecs_API)
- [FileSystem Access API - MDN](https://developer.mozilla.org/en-US/docs/Web/API/File_System_Access_API)
- [mp4-muxer - GitHub](https://github.com/Vanilagy/mp4-muxer)
- [mp4box.js - GitHub](https://github.com/gpac/mp4box.js)
