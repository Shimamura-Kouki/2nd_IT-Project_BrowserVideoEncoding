# プログレスバー修正完了報告

## 問題の概要

動画エンコード処理中、プログレスバーが実際のエンコード進捗を正確に反映していませんでした。
具体的には、プログレスバーがすぐに100%に達してしまい、その後実際のエンコード処理が続いている状態でした。

## 根本原因

このアプリケーションは2パス方式でエンコードを行います：

### 第1パス：フォーマット検出（186-190行目）
- 入力動画の解像度、音声形式を検出
- デコードのみ実行（エンコードはしない）
- "reading" ステージとして進捗報告（0-100%）

### 第2パス：実際のエンコード（311-314行目）
- 検出されたフォーマットに基づいてMuxerとエンコーダを初期化
- デコード＋エンコードを実行
- **問題箇所**: ファイル読み込み進捗（0-100%）を "encoding" ステージとして報告していた

### 実際のエンコード進捗（87-97行目）
- VideoEncoderのoutputコールバック内で計算
- エンコードされた動画のタイムスタンプベースで進捗を算出
- より正確な進捗を報告

## 問題の詳細

第2パスでは、ファイル読み込み（高速）の進捗が「エンコード進捗」として報告されていました。
これにより：

1. ファイル読み込みが完了（数秒）→ プログレスバー100%表示
2. 実際のエンコード処理が続行中（数分）→ プログレスバーは100%のまま動かない
3. ユーザーは処理が完了したと誤解する可能性

実際のエンコード進捗（タイムスタンプベース）は正しく計算されていましたが、
ファイル読み込み進捗によって上書きされてしまっていました。

## 修正内容

### 変更ファイル
`video-encoder-app/frontend/lib/encoder.js` の311-314行目

### 修正前
```javascript
await demuxAndDecode(file, videoDecoder, audioDecoder, (pct) => {
    const percent = pct;
    onProgress({ stage: 'encoding', percent, fps: undefined, elapsedMs: performance.now() - start });
});
```

### 修正後
```javascript
await demuxAndDecode(file, videoDecoder, audioDecoder, (pct) => {
    // Don't report demuxing progress during encoding pass - it overrides real encoding progress
    // The actual encoding progress is reported by videoEncoder.output callback
});
```

## 修正後の動作

### プログレスバーの流れ
1. **Reading (0-100%)**: 第1パスのファイル読み込み - 数秒で完了
2. **Encoding (0-100%)**: 実際のエンコード進捗 - タイムスタンプベースで正確に表示
3. **Flushing**: エンコーダのフラッシュ処理
4. **Finalizing**: Muxerのファイナライズ＋ファイル書き込み完了

### エンコード進捗の計算方法
```javascript
// videoEncoder.output コールバック内（87-97行目）
const encPercent = Math.min(100, 100 * (encodedVideoUs / totalVideoDurationUs));
```

- `encodedVideoUs`: これまでにエンコードされた動画の長さ（マイクロ秒）
- `totalVideoDurationUs`: 入力動画の総時間（マイクロ秒）
- 実際の処理進捗を正確に反映

## 検証結果

✅ ビルド成功  
✅ コードレビュー通過（問題なし）  
✅ セキュリティスキャン通過（脆弱性なし）  
✅ 最小限の変更（lib/encoder.js の2行のみ）  

## 技術的な詳細

### なぜ2パス方式なのか

1. **第1パス**: Muxer初期化前に入力動画のフォーマットを知る必要がある
   - 解像度（width x height）
   - 音声形式（サンプルレート、チャンネル数）
   - 総時間（エンコード進捗計算用）

2. **第2パス**: 検出したフォーマットでMuxerとエンコーダを正しく設定してエンコード実行

### 進捗報告の優先順位

- VideoEncoder.output（タイムスタンプベース）> ファイル読み込み進捗
- 第2パスではファイル読み込み進捗を無視することで、正確なエンコード進捗のみを表示

## ユーザーへの影響

### 修正前
- プログレスバーがすぐに100%になり、その後動かない
- 処理完了まで実際にどれくらい時間がかかるか不明
- 処理が固まったように見える

### 修正後
- プログレスバーが実際のエンコード進捗を正確に反映
- 残り時間の予測が可能
- 処理が正常に進行していることが視覚的に確認可能

## 企画書との整合性

✅ **ブラウザ完結**: バックエンド変更なし、フロントエンドのみの修正  
✅ **最小限の変更**: 2行のコメントアウト/コメント追加のみ  
✅ **ユーザビリティ向上**: 企画書に記載の「プログレスバーと残り時間予測を可視化」の実現  

## まとめ

プログレスバーが実際のエンコード進捗を正確に反映するようになりました。
動画作成自体は正常に機能しており、問題はプログレスバーの表示のみでした。
最小限の変更（2行）で問題を解決し、セキュリティ上の問題もありません。
