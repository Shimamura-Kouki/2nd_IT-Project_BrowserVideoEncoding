# 企画書：ブラウザ完結型 動画エンコードWebアプリケーション

## 1. プロジェクト概要

* **プロジェクト名** ：クライアントサイド分散処理による「ブラウザ完結型 動画エンコードWebアプリ」構築
* **提案者** ：島村 光輝（スーパーITエンジニア科）
* **日付** ：2025年12月9日
* **更新日** ：2025年12月23日（v2）

## 2. 背景と目的

### 背景（現状の課題）

一般的な動画変換サービスはサーバー側で演算を行うため、運営者には**莫大なCPU/GPUコスト**がかかり、ユーザーには「プライベートな動画をアップロードする」という**セキュリティ上の不安**があります。

また、SNSやチャットツール（Discord, X/Twitter等）には厳格な **ファイルアップロード容量制限** （例：8MB, 25MB）が存在しますが、既存のツールではビットレート計算が複雑で、適切なサイズに圧縮するのが困難です。

### 目的（ソリューション）

最新のWeb標準技術（WebCodecs API）を活用し、**「サーバー負荷ゼロ（計算コストの分散）」と「プライバシー保護（ローカル処理）」**を両立する動画エンコードシステムを構築します。

また、容量制限に合わせて画質を最大化する自動調整機能を搭載し、ユーザーの利便性を向上させます。さらに、開発課題要件（PHP/MySQL/MVC）を満たすため、エンコード設定と処理速度（ベンチマーク）を共有する「ナレッジベース機能」を実装します。

## 3. ターゲットとニーズ

* **動画編集初心者** ：「ソフトのインストールは面倒」「Discordに動画を貼りたいけど8MBを超えて送れない」「計算せずにピッタリのサイズにしたい」
* **開発者・ギーク層** ：「ブラウザの限界性能を試したい」「最適なエンコード設定（AV1等）を知りたい」

## 4. システム機能要件

### Tier 1：コア機能（MVP）

1. **ストリーム書き込み機能（最重要技術）**
   * **課題** ：ブラウザのメモリ上で動画全体を保持すると、数分間の動画でクラッシュする。
   * **解決策** ：`FileSystem Access API` を採用。エンコードされた断片（Chunk）を順次ローカルファイルに書き出し、メモリ枯渇を防ぐ。これにより1080p長尺動画の生成を可能にする。
2. **WebCodecsエンコード処理**
   * ハードウェアアクセラレーションを利用した高速エンコード（H.264, VP9, 可能ならAV1）。
3. **容量ターゲットエンコード（アップロード制限対応）**
   * **機能** ：指定されたファイルサイズ（例：8MB）を超えないよう、動画の長さ（Duration）と音声ビットレートから逆算して、最適な映像ビットレートを自動設定する。
   * **対応プリセット** ：
     * Discord Free (8MB) / Nitro Basic (50MB)
     * X (Twitter) / Gmail (25MB)
     * 任意サイズ指定 (Custom)
   * **安全マージン** ：コンテナ（MP4/WebM）のヘッダーサイズ等を考慮し、ターゲット容量の約95%〜98%を目指してエンコードを行う。
4. **ベンチマーク自動計測**
   * エンコードにかかった時間、平均FPS、圧縮率を自動で記録する。

### Tier 2：ナレッジ共有機能（PHP/MySQL活用）

1. **設定＆スコア投稿API**
   * ユーザーが使用した「設定（JSON）」と、その結果である「ベンチマークスコア」をサーバーへ送信。
2. **プリセット配布機能**
   * サーバー上のDBから推奨設定（HQ / Mobile / Ultra Low）を取得し、UIに反映。

## 5. 技術構成（アーキテクチャ）

### フロントエンド（SPA）

* **Framework** : Svelte（軽量・高速なUI構築）
* **Core API** :
  * `WebCodecs API`: 動画のデコード・エンコード
  * `FileSystem Access API`: ローカルファイルへの直接書き込み
  * `MP4Box.js` / `WebM Muxer`: コンテナ格納（Muxing）処理
* **Logic** :
  * **Bitrate Calculator** : 総容量と動画時間から `(目標容量 - 音声容量) ÷ 秒数 = 映像ビットレート` を算出するロジックを実装。
* **Validation** : ユーザー環境（ブラウザ）の機能対応状況を判定し、非対応なら警告を表示。

### バックエンド（REST API）

* **Language** : PHP（MVC構成）
* 役割：HTMLの生成は行わず、JSONデータの送受信（API）に特化させる。
* **Database** : MySQL
* 役割：エンコード設定のプリセット管理、およびユーザー投稿データの永続化。

### データベース設計（簡易ER図）

| **テーブル名** | **内容** | **主なカラム**                                                                                         |
| -------------------- | -------------- | ------------------------------------------------------------------------------------------------------------ |
| **presets**    | 公式設定       | `id`,`name`,`config_json`(設定値)                                                                      |
| **posts**      | ユーザー投稿   | `id`,`user_name`,`comment`,`config_json`,`benchmark_result`(処理時間/FPS),`user_agent`(環境情報) |

## 6. UI/UXデザイン方針

* **OneUIライクなモダンデザイン**
  * カード型レイアウト、大きく押しやすいボタン配置。
  * プログレスバーと「残り時間予測」を可視化し、待機ストレスを軽減。
* **サービス別「ピッタリ」モード**
  * 「Discord向け（8MB）」「Twitter向け」などのアイコン付きボタンを用意し、ワンタップで最適な設定を適用可能にする。
* **パフォーマンスの可視化**
  * 処理完了後に「あなたのPCは〇〇秒で処理しました（スコア：A）」といったリザルト画面を表示し、共有（投稿）を促す。

## 7. 開発スケジュール（5週間）

* **Week 1：設計フェーズ**
  * UIワイヤーフレーム作成（Figma等）
  * DBスキーマ定義、APIエンドポイント設計
  * **技術検証** ：FileSystem Access APIを使った「巨大ファイルの書き出し」テスト
* **Week 2-3：コア機能実装（高難易度）**
  * WebCodecsによるデコード・エンコードパイプラインの構築
  * Muxing（MP4化）とファイル保存の実装
  * **追加実装** ：容量計算ロジック（Bitrate Calculator）の実装とUIへの組み込み
* **Week 4：バックエンド実装**
  * PHPによるAPI実装（投稿・取得）
  * MySQLデータベース構築と接続
* **Week 5：統合・テスト**
  * フロントとバックの結合
  * ブラウザ互換性チェック（Chrome / Edge）
  * 最終調整

## 8. リスクと対策

* **リスク** ：WebCodecs APIの仕様が複雑で、特定環境で動作しない可能性がある。
* **対策** ：ターゲットを「Chrome/Edge（Chromium系）」に絞ることを明記。非対応ブラウザでは閲覧モードのみ提供する。
* **リスク** ：セキュリティ（XSS等）。
* **対策** ：PHP側での入力値検証に加え、フロントエンド表示時にもエスケープ処理を徹底する。
* **リスク** ：可変ビットレート（VBR）の振れ幅により、指定容量を僅かに超えてしまう可能性がある。
* **対策** ：計算時に安全マージン（5%程度）を確保するほか、エンコード完了後にファイルサイズチェックを行い、超過時には警告を出すか再エンコードを提案するフローを検討する。

## 9. 結論

本プロジェクトは、学校課題である「PHP/MySQLの実装」を満たしつつ、Web技術の最先端（WebCodecs + FileSystem API）を検証する挑戦的な取り組みです。「サーバーコスト削減」や「アップロード容量制限の解決」という実用的なメリットも提示できるため、エンジニアとしての技術力をアピールする最適なポートフォリオとなります。
