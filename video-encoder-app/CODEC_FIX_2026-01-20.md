# AVC Codec Level 修正レポート

**日付**: 2026年1月20日  
**問題**: VideoEncoderとAudioEncoderで複数のエラーが発生

## 発生したエラー

### 1. VideoEncoder エラー
```
VideoEncoder error NotSupportedError: The provided resolution (1280x720) has a coded area (1280*720=921600) 
which exceeds the maximum coded area (414720) supported by the AVC level (3.0) indicated by the codec string (0x1E).
```

**原因**: `avc1.42e01e` (AVC level 3.0) は720pの解像度をサポートしていない

### 2. AudioEncoder エラー
```
AudioEncoder error EncodingError: Input audio buffer is incompatible with codec parameters
Uncaught InvalidStateError: Failed to execute 'encode' on 'AudioEncoder': Cannot call 'encode' on a closed codec.
```

**原因**: エンコーダーがクローズされた後もエンコード処理を呼び出していた

## 実施した修正

### 1. Codec Level の変更

正しく動作していたコミット `47e6f1724ee0015187a713d77169644d9d1809ba` の設定に基づき、以下のように修正:

- **変更前**: `avc1.42e01e` (Level 3.0 - 最大解像度 720x576)
- **変更後**: `avc1.42001f` (Level 3.1 - 最大解像度 1280x720)

#### 修正ファイル:
1. `video-encoder-app/frontend/src/lib/core/encoder.js`
   - デフォルトcodec: `'avc1.42001f'`

2. `video-encoder-app/frontend/src/lib/presets.js`
   - 1080p30 preset: `'avc1.42001f'`
   - 720p30 preset: `'avc1.42001f'`

3. `video-encoder-app/frontend/src/App.svelte`
   - デフォルトpreset: `'avc1.42001f'`

### 2. エンコーダー状態チェックの追加

クローズされたエンコーダーへのアクセスを防ぐため、状態チェックとエラーハンドリングを追加:

#### `video-encoder-app/frontend/src/lib/core/encoder.js`

**VideoDecoder の output コールバック:**
```javascript
output: (frame) => {
    frameCount++;
    if (videoEncoder && videoEncoder.state === 'configured') {
        try {
            videoEncoder.encode(frame);
        } catch (e) {
            console.error('VideoEncoder encode error:', e);
        }
    }
    frame.close();
    // ... 残りの処理
}
```

**AudioDecoder の output コールバック:**
```javascript
output: (audioData) => {
    if (audioEncoder && audioEncoder.state === 'configured') {
        try {
            audioEncoder.encode(audioData);
        } catch (e) {
            console.error('AudioEncoder encode error:', e);
        }
    }
    audioData.close();
}
```

## AVC Level について

| Level        | 最大解像度          | 最大ビットレート |
| ------------ | ------------------- | ---------------- |
| 3.0 (`0x1E`) | 720x576 (SD)        | 10 Mbps          |
| 3.1 (`0x1F`) | 1280x720 (HD)       | 14 Mbps          |
| 4.0 (`0x28`) | 1920x1080 (Full HD) | 20 Mbps          |

## 期待される効果

1. ✅ 720p および 1080p の動画エンコードが正常に動作
2. ✅ エンコーダーがクローズされた後のエラーが発生しない
3. ✅ オーディオエンコードの安定性が向上

## 次のステップ

1. フロントエンドのビルド実行
2. GitHub Pages へのデプロイ
3. ブラウザでの動作確認
