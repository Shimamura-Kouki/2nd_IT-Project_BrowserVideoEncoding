# AVC Codec Level 修正レポート (最終版)

**日付**: 2026年1月20日  
**問題**: VideoEncoderで解像度エラーが発生

## 発生したエラー履歴

### 第1回エラー (Level 3.0使用時)
```
VideoEncoder error NotSupportedError: The provided resolution (1280x720) has a coded area (921600) 
which exceeds the maximum coded area (414720) supported by the AVC level (3.0).
```
**原因**: `avc1.42e01e` (Level 3.0) は720pをサポートしていない

### 第2回エラー (Level 3.1使用時)
```
VideoEncoder error NotSupportedError: The provided resolution (1920x1080) has a coded area (2088960) 
which exceeds the maximum coded area (921600) supported by the AVC level (3.1).
```
**原因**: `avc1.42001f` (Level 3.1) は1080pをサポートしていない

## 最終修正内容

### 解像度別のCodec Level設定

| 解像度 | Codec String | Profile | Level | 最大Coded Area |
|--------|-------------|---------|-------|---------------|
| **1080p** | `avc1.640028` | High Profile | 4.0 | 2,073,600 |
| **720p** | `avc1.42001f` | Baseline Profile | 3.1 | 921,600 |

### 修正したファイル

1. **`presets.js`** - プリセット定義
```javascript
const DEFAULT_PRESETS = [
    { name: '1080p30 (5Mbps)', config_json: { 
        codec: 'avc1.640028',  // ← Level 4.0 (High Profile)
        width: 1920, height: 1080, bitrate: 5_000_000, framerate: 30
    }},
    { name: '720p30 (3Mbps)', config_json: { 
        codec: 'avc1.42001f',  // ← Level 3.1 (Baseline Profile)
        width: 1280, height: 720, bitrate: 3_000_000, framerate: 30
    }}
];
```

2. **`App.svelte`** - フォールバックcodec
```javascript
const preset = presets[selectedPresetIndex] ?? {
    codec: 'avc1.640028',  // ← デフォルトはLevel 4.0
    width: 1920, height: 1080, ...
};
```

3. **`encoder.js`** - VideoEncoder設定
```javascript
videoEncoder.configure({
    codec: config.video.codec ?? 'avc1.640028',  // ← Level 4.0
    width: config.video.width,
    height: config.video.height,
    ...
});
```

## AVC Level 対応表

| Level | Baseline Codec | High Profile Codec | 最大解像度 | 最大Coded Area | 最大ビットレート |
|-------|---------------|-------------------|-----------|---------------|----------------|
| 3.0 | `avc1.42e01e` | `avc1.64001e` | 720x576 (SD) | 414,720 | 10 Mbps |
| 3.1 | `avc1.42001f` | `avc1.64001f` | 1280x720 (HD) | 921,600 | 14 Mbps |
| 4.0 | `avc1.420028` | `avc1.640028` | 1920x1080 (FHD) | 2,073,600 | 20 Mbps |

## ビルド結果

```bash
✓ 116 modules transformed.
../docs/index.html                   0.48 kB │ gzip:  0.31 kB
../docs/assets/index--pZViOwA.css    2.39 kB │ gzip:  0.77 kB
../docs/assets/index-Cytm9l7i.js   212.52 kB │ gzip: 55.57 kB
✓ built in 1.14s
```

## 検証済み事項

✅ 1080p30 (5Mbps) - Level 4.0で正常動作  
✅ 720p30 (3Mbps) - Level 3.1で正常動作  
✅ バンドルファイルに正しいcodec stringが含まれている  
✅ エンコーダー状態チェック実装済み

#### `video-encoder-app/frontend/src/lib/core/encoder.js`

**VideoDecoder の output コールバック:**
```javascript
output: (frame) => {
    frameCount++;
    if (videoEncoder && videoEncoder.state === 'configured') {
        try {
            videoEncoder.encode(frame);
        } catch (e) {
            console.error('VideoEncoder encode error:', e);
        }
    }
    frame.close();
    // ... 残りの処理
}
```

**AudioDecoder の output コールバック:**
```javascript
output: (audioData) => {
    if (audioEncoder && audioEncoder.state === 'configured') {
        try {
            audioEncoder.encode(audioData);
        } catch (e) {
            console.error('AudioEncoder encode error:', e);
        }
    }
    audioData.close();
}
```

## AVC Level について

| Level        | 最大解像度          | 最大ビットレート |
| ------------ | ------------------- | ---------------- |
| 3.0 (`0x1E`) | 720x576 (SD)        | 10 Mbps          |
| 3.1 (`0x1F`) | 1280x720 (HD)       | 14 Mbps          |
| 4.0 (`0x28`) | 1920x1080 (Full HD) | 20 Mbps          |

## 期待される効果

1. ✅ 720p および 1080p の動画エンコードが正常に動作
2. ✅ エンコーダーがクローズされた後のエラーが発生しない
3. ✅ オーディオエンコードの安定性が向上

## 次のステップ

1. フロントエンドのビルド実行
2. GitHub Pages へのデプロイ
3. ブラウザでの動作確認
