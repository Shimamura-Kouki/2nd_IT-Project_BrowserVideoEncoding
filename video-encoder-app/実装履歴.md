# 実装履歴

- 初回生成: frontend(Svelte+Vite) と backend(PHP MVC) を作成。
- WebCodecsパイプライン: `demuxer.js` で mp4box を用いた逐次デマックス、`encoder.js` で Video/Audio 並列エンコードと mp4-muxer へのストリーム書き込みを実装。
- APIクライアント: `src/lib/api/client.js` にプリセット取得/投稿APIを実装。
- UI: `App.svelte` にドロップゾーン、プリセット選択、進捗/FPS表示、共有送信を実装。
- Backend: `public/api/index.php` エントリ、`PresetController`/`PostController`、`Database`/`ApiController` を実装。`database.sql` にDDL/DML投入。

## 2025-12-23 修正
- frontend/lib/encoder.js: mp4-muxer 初期化時に `firstTimestampBehavior: 'offset'` を設定し、入力トラックの先頭タイムスタンプが0でない場合でも自動的にゼロ起点へオフセットするよう対応。これにより "The first chunk for your media track must have a timestamp of 0" エラーを解消。
- frontend/index.html: 進捗表示のFPS/経過時間のフォーマットを安全化。`stats.fps`/`stats.elapsedMs` が未定義や非有限値の場合に `toFixed` を呼ばないようガードし、`-` を表示するように変更。これにより `Cannot read properties of undefined (reading 'toFixed')` を解消。
 - frontend/lib/demuxer.js: デマックス時に動画サンプルから総デュレーション（microseconds）を算出し、`durationUs` として返却。
 - frontend/lib/encoder.js: エンコードの出力メタデータ（timestamp/duration）から処理済みデュレーションを推定し、進捗を 80→90% の間で連続更新。Flush/Finalize の進捗は 90→98→100% に調整し、80%固定に見えないよう改善。
 - frontend/lib/encoder.js: mp4-muxer へ渡す `meta.timestamp` を最初の出力タイムスタンプ基準で正規化（先頭を0起点に調整）。`firstTimestampBehavior` が効かないケースでも、強制的にゼロ起点になるよう安全策を追加。
